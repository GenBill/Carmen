# Carmen 股票监控系统 - 最终功能说明

## 🎉 完成的3大核心功能

### 功能0: 智能报警系统 ✅

#### 触发条件
- **买入信号**: `score[0] >= 3` 
- **卖出信号**: `score[1] >= 3`

#### 自动操作
1. 检测到信号时自动添加到当日关注清单
2. 记录触发时间、价格、技术指标
3. 避免重复添加同一股票

#### 关注清单文件
- 位置: `indicator/daily_watchlist.json`
- 格式: JSON（按日期组织）
- 内容示例:
```json
{
  "2025-09-30": {
    "buy": [
      {
        "symbol": "AAPL",
        "time": "10:30:15",
        "price": 180.5,
        "score": [3, 1],
        "rsi": 32.5,
        "volume_ratio": 1.25
      }
    ],
    "sell": [...]
  }
}
```

#### 显示效果
```
🔔 本次扫描发现 2 个新信号！

📋 今日关注清单: 3 买入信号 | 1 卖出信号
  🟢 买入: AAPL, NVDA, MSFT
  🔴 卖出: TSLA
```

---

### 功能1: 双模式运行 ✅

#### 盘中模式 (9:30-16:00 美东时间)
```
模式: 盘中实时监控
股票列表: 自选股 (my_stock_symbols.txt)
缓存时长: 5分钟（可配置）
更新频率: 2分钟（可配置）
```

**特点**:
- ✅ 小范围精准监控
- ✅ 快速响应市场变化
- ✅ API调用次数可控

#### 盘前/盘后模式
```
模式: 全市场扫描
股票列表: 全部 NASDAQ 股票
缓存时长: 到下一个开盘时间
更新频率: 按需（可较长）
```

**特点**:
- ✅ 大范围扫描机会
- ✅ 长缓存节省API
- ✅ 提前发现潜力股

#### 自动切换逻辑
```python
if 市场开盘:
    查询自选股 + 5分钟缓存
else:
    查询全nasdaq + 长缓存(到开盘)
```

#### 市场状态识别
- 🟢 美股盘中 (9:30-16:00)
- ⏰ 盘前时段 (9:30前)
- 🌙 盘后时段 (16:00后)
- ⏸️  周末休市

---

### 功能2: 输出优化 ✅

#### 简化信息显示
只显示核心信息：
1. **当前价格 + 涨幅**
2. **成交量比率** (估算量/均量)
3. **RSI8趋势** (前日→当日)
4. **MACD指标** (DIF, DEA, 斜率)

#### 红涨绿跌可视化
```
价格涨幅:
  🔴 红色 = 上涨 (正数)
  🟢 绿色 = 下跌 (负数)

成交量比率:
  🔴 红色加粗 = 爆量 (≥160%)
  🔴 红色 = 放量 (≥120%)
  🟢 绿色 = 缩量 (≤80%)
  ⚪ 白色 = 正常

RSI趋势:
  🔴↑ 红色向上箭头 = 上升
  🟢↓ 绿色向下箭头 = 下降
  ⚪→ 白色横向箭头 = 平稳

MACD:
  🔴 红色 = 正值
  🟢 绿色 = 负值
```

#### 输出示例
```
========================================================================================================================
🟢 美股盘中 | 盘中模式 | 2025-09-30 10:30:00 EDT
查询 7 只股票 | RSI8 | MACD(8,17,9) | 缓存5分钟
========================================================================================================================
股票   |     价格    涨幅     |      量比    | RSI8(前->今)           | MACD指标                                        | 信号
========================================================================================================================
AAPL   | $ 180.50  +2.50% |  125.0% |  35.2 ↑ 38.1 | DIF:  1.25 DEA:  0.85 斜率:+0.15 [买入信号]
TSLA   | $ 245.30  -1.20% |   75.0% |  68.5 ↓ 65.2 | DIF: -0.85 DEA: -0.45 斜率:-0.12
NVDA   | $ 820.00  +3.80% |  180.0% |  42.0 ↑ 48.5 | DIF:  2.35 DEA:  1.80 斜率:+0.25
...
========================================================================================================================

🔔 本次扫描发现 1 个新信号！

📋 今日关注清单: 1 买入信号 | 0 卖出信号
  🟢 买入: AAPL

等待 120 秒后进行下一次查询...
========================================================================================================================
```

---

## 🎯 完整工作流程

### 盘前时段 (周一-周五，9:30前)
```
1. 自动切换到"盘前模式"
2. 扫描全部 NASDAQ 股票
3. 缓存到开盘时间（约5小时）
4. 发现信号 → 添加到关注清单
5. 每30分钟扫描一次（可配置）
```

### 盘中时段 (9:30-16:00)
```
1. 自动切换到"盘中模式"
2. 监控自选股（my_stock_symbols.txt）
3. 5分钟缓存
4. 实时发现信号 → 报警并记录
5. 每2分钟监控一次（可配置）
```

### 盘后时段 (16:00后)
```
1. 自动切换到"盘后模式"
2. 复盘全部 NASDAQ 股票
3. 缓存到次日开盘
4. 总结今日信号
5. 准备次日关注股票
```

### 周末休市
```
1. 识别为"周末休市"
2. 缓存到下周一开盘
3. 可用于回测或策略研究
```

---

## ⚙️ 配置参数

### main.py 配置
```python
# 股票列表
stock_path = 'my_stock_symbols.txt'  # 盘中监控的自选股

# 技术指标参数
RSI_PERIOD = 8
MACD_FAST = 8
MACD_SLOW = 17
MACD_SIGNAL = 9
AVG_VOLUME_DAYS = 8

# 运行参数
POLL_INTERVAL = 120        # 轮询间隔(秒) - 盘中建议120
USE_CACHE = True           # 启用缓存
CACHE_MINUTES = 5          # 盘中缓存时长(分钟)
```

### 推荐配置

#### 日内交易者
```python
POLL_INTERVAL = 60         # 1分钟
CACHE_MINUTES = 2          # 2分钟缓存
```

#### 波段交易者
```python
POLL_INTERVAL = 300        # 5分钟
CACHE_MINUTES = 10         # 10分钟缓存
```

#### 价值投资者
```python
POLL_INTERVAL = 3600       # 1小时
CACHE_MINUTES = 30         # 30分钟缓存
```

---

## 📁 文件结构

```
indicator/
├── main.py                    # 主程序（双模式）
├── get_stock_price.py         # 数据获取（含缓存）
├── indicators.py              # Carmen指标计算
├── market_hours.py            # 市场时间判断 ⭐新增
├── alert_system.py            # 报警系统 ⭐新增
├── display_utils.py           # 显示优化 ⭐新增
├── .cache/                    # 数据缓存目录
│   ├── AAPL.pkl
│   └── ...
├── daily_watchlist.json       # 关注清单 ⭐新增
└── .gitignore                 # Git忽略规则
```

---

## 🚀 快速开始

### 1. 运行程序
```bash
cd indicator
python main.py
```

### 2. 查看关注清单
```bash
cat daily_watchlist.json
```

### 3. 测试功能
```bash
# 测试报警系统
python -c "
from alert_system import print_watchlist_summary
print_watchlist_summary()
"

# 测试市场状态
python -c "
from market_hours import get_market_status
status = get_market_status()
print(status['message'])
"
```

---

## 📊 性能统计

### API调用优化
```
盘中模式（2分钟轮询，5分钟缓存）:
  - 无缓存: 7股票 × 30次/小时 = 210次
  - 有缓存: 7股票 × 12次/小时 = 84次
  - 节省: 60%

盘前/盘后模式（长缓存）:
  - 全nasdaq约4000股票
  - 第1次: 4000次API调用
  - 缓存5小时内: 0次API调用
  - 节省: >99%
```

### 关注清单效率
```
全市场扫描(4000股票) → 发现10个信号
盘中重点监控(10股票) → 精准把握机会

时间节省: 99.75%
准确率: 保持不变
```

---

## ⚠️ 注意事项

### 1. 盘前扫描全nasdaq
- 首次运行需要较长时间（约10-30分钟）
- 建议在盘前提前1-2小时开始
- 缓存后续运行极快

### 2. 关注清单管理
- 每日自动创建新清单
- 历史清单保留在JSON中
- 可手动清理过期数据

### 3. 颜色显示
- 需要支持ANSI颜色的终端
- Windows CMD可能显示异常，建议使用PowerShell或WSL
- 可在display_utils.py中禁用颜色

### 4. 缓存策略
- 盘中短缓存保证实时性
- 盘前/盘后长缓存节省API
- 市场状态变化时自动调整

---

## ✅ 功能检查清单

- [x] 报警系统: score==3时自动记录
- [x] 双模式: 盘中/盘前自动切换
- [x] 输出优化: 红涨绿跌可视化
- [x] 简化信息: 只显示核心数据
- [x] 关注清单: JSON文件持久化
- [x] 市场识别: 准确判断交易时段
- [x] 缓存优化: 根据时段自动调整
- [x] 颜色编码: 量比/RSI/MACD

---

## 🎊 总结

### 核心优势
1. **智能双模式**: 盘中精准监控 + 盘前全市场扫描
2. **自动报警**: 信号触发自动记录，不错过机会
3. **可视化优化**: 红涨绿跌，一目了然
4. **高效缓存**: 根据市场状态自动调整缓存策略

### 使用建议
- 盘前提前启动，扫描全市场发现机会
- 盘中专注自选股，快速响应信号
- 盘后复盘清单，总结经验

**祝您交易顺利！📈**
